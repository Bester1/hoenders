<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plaas Hoenders Orders - Admin Dashboard</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <div class="admin-container">
        <!-- Sidebar Navigation -->
        <nav class="sidebar">
            <div class="logo">
                <h2>üêî Plaas Hoenders Admin</h2>
            </div>
            <ul class="nav-menu">
                <li><a href="#dashboard" class="nav-link active"><i class="fas fa-chart-line"></i> Dashboard</a></li>
                <li><a href="#orders" class="nav-link"><i class="fas fa-shopping-cart"></i> Orders</a></li>
                <li><a href="#invoices" class="nav-link"><i class="fas fa-file-invoice"></i> Invoices</a></li>
                <li><a href="#emails" class="nav-link"><i class="fas fa-envelope"></i> Email Center</a></li>
                <li><a href="#pricing" class="nav-link"><i class="fas fa-tags"></i> Pricing</a></li>
                <li><a href="#pdf-analysis" class="nav-link"><i class="fas fa-robot"></i> Import & Analyze Invoices</a></li>
                <li><a href="#settings" class="nav-link"><i class="fas fa-cog"></i> Settings</a></li>
            </ul>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <header class="top-bar">
                <h1 id="page-title">Dashboard</h1>
                <div class="user-info">
                    <span>Welcome, Admin</span>
                    <div class="email-status" id="emailStatus">
                        <i class="fas fa-envelope"></i>
                        <span id="emailStatusText">Google Apps Script Ready</span>
                    </div>
                </div>
            </header>

            <!-- Dashboard Section -->
            <section id="dashboard" class="content-section active">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">üì¶</div>
                        <div class="stat-info">
                            <h3>Total Orders</h3>
                            <p class="stat-number" id="totalOrders">0</p>
                            <span class="stat-change">+0 today</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üí∞</div>
                        <div class="stat-info">
                            <h3>Revenue</h3>
                            <p class="stat-number" id="totalRevenue">R0</p>
                            <span class="stat-change">+R0 today</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üìß</div>
                        <div class="stat-info">
                            <h3>Emails Sent</h3>
                            <p class="stat-number" id="emailsSent">0</p>
                            <span class="stat-change">+0 today</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">‚è≥</div>
                        <div class="stat-info">
                            <h3>Pending</h3>
                            <p class="stat-number" id="pendingOrders">0</p>
                            <span class="stat-change">Orders to process</span>
                        </div>
                    </div>
                </div>

                <div class="dashboard-grid">
                    <div class="dashboard-card">
                        <h3>Recent Activity</h3>
                        <div id="recentActivity" class="activity-list">
                            <p>No recent activity</p>
                        </div>
                    </div>
                    <div class="dashboard-card">
                        <h3>Quick Actions</h3>
                        <div class="quick-actions">
                            <button class="action-btn" onclick="showSection('orders')">
                                <i class="fas fa-plus"></i> Process New Orders
                            </button>
                            <button class="action-btn" onclick="showSection('emails')">
                                <i class="fas fa-paper-plane"></i> Send Emails
                            </button>
                            <button class="action-btn" onclick="exportData()">
                                <i class="fas fa-download"></i> Export Data
                            </button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Orders Section -->
            <section id="orders" class="content-section">
                <div class="section-header">
                    <h2>Order Management</h2>
                    <div class="header-actions">
                        <button class="btn-secondary" onclick="showImportManager()">
                            <i class="fas fa-folder"></i> Manage Imports
                        </button>
                        <button class="btn-primary" onclick="importOrders()">
                            <i class="fas fa-upload"></i> New Import
                        </button>
                    </div>
                </div>

                <div class="imports-overview">
                    <div class="current-import-info">
                        <div class="import-selector">
                            <label>Current Import:</label>
                            <select id="importSelector" onchange="switchImport(this.value)">
                                <option value="">Select an import...</option>
                            </select>
                        </div>
                        <div class="import-stats" id="importStats">
                            <span class="stat">No import selected</span>
                        </div>
                    </div>
                </div>
                
                <div class="import-area">
                    <div class="import-options">
                        <div class="csv-upload">
                            <input type="file" id="csvFileInput" accept=".csv" style="display: none;" onchange="handleCSVUpload(event)">
                            <button onclick="triggerCSVUpload()" class="btn-secondary">
                                <i class="fas fa-file-csv"></i> Upload CSV File
                            </button>
                            <span id="csvFileName" class="file-name"></span>
                        </div>
                        <div class="divider">or</div>
                        <button onclick="toggleManualInput()" class="btn-secondary">
                            <i class="fas fa-paste"></i> Paste Data Manually
                        </button>
                    </div>
                    <div id="manualInputArea" style="display: none;">
                        <textarea id="orderData" placeholder="Paste your Google Sheets data here..." rows="8"></textarea>
                        <button onclick="processOrders()" class="btn-primary">Process Orders</button>
                    </div>
                    <div id="csvPreview" style="display: none;">
                        <h4>CSV File Loaded: <span id="previewFileName"></span></h4>
                        <p>Found <span id="previewRowCount">0</span> orders ready to process</p>
                        <button onclick="processCSVFile()" class="btn-primary">Process CSV Orders</button>
                        <button onclick="clearCSVUpload()" class="btn-secondary">Clear</button>
                    </div>
                </div>

                <div class="orders-table-container">
                    <table id="ordersTable" class="data-table">
                        <thead>
                            <tr>
                                <th>Order ID</th>
                                <th>Date</th>
                                <th>Customer</th>
                                <th>Email</th>
                                <th>Phone</th>
                                <th>Address</th>
                                <th>Product</th>
                                <th>Quantity</th>
                                <th>Total</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="ordersTableBody">
                            <tr>
                                <td colspan="11" class="no-data">No orders loaded</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Invoices Section -->
            <section id="invoices" class="content-section">
                <div class="section-header">
                    <h2>Invoice Management</h2>
                    <div class="header-actions">
                        <select id="invoiceImportSelector" onchange="switchInvoiceImport(this.value)">
                            <option value="">Select import for invoicing...</option>
                        </select>
                        <button class="btn-primary" onclick="generateAllInvoices()" id="generateAllBtn" disabled>
                            <i class="fas fa-file-pdf"></i> Generate All Invoices
                        </button>
                    </div>
                </div>

                <div class="invoice-import-info" id="invoiceImportInfo" style="display: none;">
                    <div class="import-summary">
                        <span id="invoiceImportName"></span>
                        <span id="invoiceImportStats"></span>
                    </div>
                </div>

                <div class="invoices-grid" id="invoicesGrid">
                    <p class="no-data">No invoices generated yet</p>
                </div>
            </section>

            <!-- Email Center Section -->
            <section id="emails" class="content-section">
                <div class="section-header">
                    <h2>Email Center</h2>
                    <div class="email-actions">
                        <button class="btn-secondary" onclick="testEmail()">
                            <i class="fas fa-paper-plane"></i> Send Test Email
                        </button>
                    </div>
                </div>

                <div class="email-grid">
                    <div class="email-card">
                        <h3>Google Apps Script Configuration</h3>
                        <div class="config-info">
                            <p>Email service is configured via Google Apps Script.</p>
                            <p>No additional configuration needed in the admin panel.</p>
                            <a href="GOOGLE_APPS_SCRIPT_SETUP.md" target="_blank" class="btn-secondary">
                                <i class="fas fa-book"></i> View Setup Guide
                            </a>
                        </div>
                    </div>

                    <div class="email-card">
                        <h3>Email Template</h3>
                        <div class="form-group">
                            <label>Subject Template:</label>
                            <input type="text" id="emailSubject" value="Invoice for your Plaas Hoenders order - Order #{orderNumber}">
                        </div>
                        <div class="form-group">
                            <label>Email Body:</label>
                            <textarea id="emailTemplate" rows="15">Goeie naand {customerName},

Baie dankie vir die bestelling, ek waardeer dit. Neem assb kenis van nuwe bank besonderhede. Ek sien jul Saterdag oggend, vind asb staat aangeheg vir bestelling #{orderNumber}.

{invoiceDetails}

Hierdie is met n nuwe stelsel geproduseer en fe email ,as daar foute is laat my asb weet, daar was n te min aan lewer.

Groete
Adriaan Bester
079 616 7761

My bank details:
CAPITEC - Adriaan Bester
Rek no:2258491149
Savings/Spaar rek</textarea>
                        </div>
                        <button onclick="saveEmailTemplate()" class="btn-secondary">Save Template</button>
                    </div>
                </div>

                <div class="email-queue">
                    <h3>Email Queue</h3>
                    <div id="emailQueue" class="queue-list">
                        <p class="no-data">No emails in queue</p>
                    </div>
                    <button onclick="sendQueuedEmails()" class="btn-primary">
                        <i class="fas fa-paper-plane"></i> Send All Queued Emails
                    </button>
                </div>
            </section>

            <!-- Pricing Section -->
            <section id="pricing" class="content-section">
                <div class="section-header">
                    <h2>Pricing Management</h2>
                    <button class="btn-primary" onclick="addNewProduct()">
                        <i class="fas fa-plus"></i> Add Product
                    </button>
                </div>

                <div class="pricing-table-container">
                    <table id="pricingTable" class="data-table">
                        <thead>
                            <tr>
                                <th>Product Name</th>
                                <th>Cost Price</th>
                                <th>Selling Price</th>
                                <th>Margin</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="pricingTableBody">
                            <!-- Default pricing will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- AI PDF Analysis Section -->
            <section id="pdf-analysis" class="content-section">
                <div class="section-header">
                    <h2>üìÑ Import & Analyze Butchery Invoices</h2>
                    <div class="analysis-actions">
                        <button class="btn-secondary" onclick="clearAnalysisHistory()">
                            <i class="fas fa-trash"></i> Clear History
                        </button>
                    </div>
                </div>

                <div class="analysis-grid">
                    <div class="upload-card">
                        <h3>üìÑ Import Butchery Invoice PDF</h3>
                        <div class="upload-area" id="pdfUploadArea">
                            <input type="file" id="pdfFileInput" accept=".pdf" style="display: none;" onchange="handlePDFUpload(event)">
                            <div class="upload-placeholder" onclick="triggerPDFUpload()">
                                <i class="fas fa-cloud-upload-alt"></i>
                                <p><strong>Click to import your butchery invoice PDF</strong></p>
                                <p>Or drag & drop the PDF file here</p>
                                <small>Supported format: PDF only</small>
                            </div>
                        </div>
                        
                        <div class="upload-info">
                            <h4>üîç AI Analysis will check for:</h4>
                            <ul>
                                <li>‚úÖ Pricing accuracy against your rate card</li>
                                <li>‚úÖ Product descriptions and item matching</li>
                                <li>‚úÖ Quantity vs Weight column errors</li>
                                <li>‚úÖ Item/Description field swapping</li>
                                <li>‚úÖ Missing or incorrect calculations</li>
                                <li>‚úÖ Packaging specifications compliance</li>
                            </ul>
                        </div>
                    </div>

                    <div class="current-rates-card">
                        <h3>Current Rate Card (March 2025)</h3>
                        <div class="rates-table-container">
                            <table class="rates-table">
                                <thead>
                                    <tr>
                                        <th>Product</th>
                                        <th>Your Cost (R/kg)</th>
                                        <th>Selling Price (R/kg)</th>
                                        <th>Margin</th>
                                    </tr>
                                </thead>
                                <tbody id="currentRatesTable">
                                    <!-- Will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                        <button onclick="updateRateCard()" class="btn-secondary">Update Rate Card</button>
                    </div>
                </div>

                <div class="analysis-results" id="analysisResults" style="display: none;">
                    <h3>Analysis Results</h3>
                    <div class="results-summary" id="resultsSummary"></div>
                    <div class="results-details" id="resultsDetails"></div>
                </div>

                <div class="analysis-history">
                    <h3>Analysis History</h3>
                    <div id="analysisHistoryList" class="history-list">
                        <p class="no-data">No analysis history yet</p>
                    </div>
                </div>
            </section>

            <!-- Settings Section -->
            <section id="settings" class="content-section">
                <div class="section-header">
                    <h2>Settings</h2>
                </div>

                <div class="settings-grid">
                    <div class="settings-card">
                        <h3>Business Information</h3>
                        <div class="form-group">
                            <label>Business Name:</label>
                            <input type="text" id="businessName" value="Plaas Hoenders">
                        </div>
                        <div class="form-group">
                            <label>Contact Email:</label>
                            <input type="email" id="businessEmail" placeholder="contact@plaashoenders.com">
                        </div>
                        <div class="form-group">
                            <label>Phone Number:</label>
                            <input type="tel" id="businessPhone" placeholder="+27 XX XXX XXXX">
                        </div>
                        <div class="form-group">
                            <label>Address:</label>
                            <textarea id="businessAddress" rows="3" placeholder="Business address"></textarea>
                        </div>
                    </div>

                    <div class="settings-card">
                        <h3>Banking Details</h3>
                        <div class="form-group">
                            <label>Bank Name:</label>
                            <input type="text" id="bankName" placeholder="Standard Bank">
                        </div>
                        <div class="form-group">
                            <label>Account Holder:</label>
                            <input type="text" id="accountHolder" placeholder="Plaas Hoenders (Pty) Ltd">
                        </div>
                        <div class="form-group">
                            <label>Account Number:</label>
                            <input type="text" id="accountNumber" placeholder="123456789">
                        </div>
                        <div class="form-group">
                            <label>Branch Code:</label>
                            <input type="text" id="branchCode" placeholder="051001">
                        </div>
                    </div>
                </div>

                <button onclick="saveSettings()" class="btn-primary">Save All Settings</button>

                <div class="settings-card" style="grid-column: 1 / -1; margin-top: 30px;">
                    <h3 style="color: #dc3545;">‚ö†Ô∏è Data Management</h3>
                    <p style="color: #666; margin-bottom: 20px;">Manage your application data, backups, and storage. <strong>Use with caution!</strong></p>
                    
                    <div class="data-management-grid">
                        <div class="data-action-card">
                            <h4>üì• Backup Data</h4>
                            <p>Download all your data as a backup file</p>
                            <button onclick="downloadBackup()" class="btn-secondary">
                                <i class="fas fa-download"></i> Download Backup
                            </button>
                        </div>
                        
                        <div class="data-action-card">
                            <h4>üì§ Restore Data</h4>
                            <p>Upload and restore from a backup file</p>
                            <input type="file" id="backupFileInput" accept=".json" style="display: none;" onchange="handleBackupUpload(event)">
                            <button onclick="triggerBackupUpload()" class="btn-secondary">
                                <i class="fas fa-upload"></i> Restore Backup
                            </button>
                        </div>
                        
                        <div class="data-action-card">
                            <h4>üóëÔ∏è Clear Local Data</h4>
                            <p>Remove all data stored in browser<br><small>‚ö° Pricing is protected and won't be cleared</small></p>
                            <button onclick="clearLocalData()" class="btn-danger">
                                <i class="fas fa-trash"></i> Clear Local Data
                            </button>
                        </div>
                        
                        <div class="data-action-card">
                            <h4>üóÑÔ∏è Clear Database</h4>
                            <p>Remove all data from Supabase database<br><small>‚ö° Pricing is protected and won't be cleared</small></p>
                            <button onclick="clearDatabaseData()" class="btn-danger">
                                <i class="fas fa-database"></i> Clear Database
                            </button>
                        </div>
                        
                        <div class="data-action-card">
                            <h4>üîÑ Reset Everything</h4>
                            <p>Clear all data (local + database) and reset app<br><small>‚ö° Pricing is protected and won't be cleared</small></p>
                            <button onclick="resetEverything()" class="btn-danger">
                                <i class="fas fa-exclamation-triangle"></i> Reset Everything
                            </button>
                        </div>
                        
                        <div class="data-action-card">
                            <h4>üìä Data Status</h4>
                            <div id="dataStatus">
                                <p><strong>Local Storage:</strong> <span id="localDataStatus">Loading...</span></p>
                                <p><strong>Database:</strong> <span id="databaseDataStatus">Loading...</span></p>
                                <p><strong>Total Imports:</strong> <span id="totalImports">0</span></p>
                                <p><strong>Total Orders:</strong> <span id="totalOrdersCount">0</span></p>
                            </div>
                            <button onclick="refreshDataStatus()" class="btn-secondary btn-small">
                                <i class="fas fa-refresh"></i> Refresh
                            </button>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.1.1/dist/tesseract.min.js"></script>
    <script>
        // Configure PDF.js worker
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    <script src="script.js"></script>
</body>
</html>